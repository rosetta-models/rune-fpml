version: "1.0"

steps:
  main_clone:
    type: git-clone
    git: rosetta-models
    repo: "${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}"
    revision: "${{CF_REVISION}}"

  IsTriggeredByGitHubRelease:
    image: alpine
    commands:
      - if [[ '${{CF_RELEASE_TAG}}' == *'CF_RELEASE_TAG'* ]]; then cf_export IS_RELEASE=false; else cf_export IS_RELEASE=true; fi

  ReleaseNameForBranch:
    image: alpine/git
    when:
      condition:
        all:
          releaseNameNotDefined: "${{IS_RELEASE}} == false"
    commands:
      - cf_export RELEASE_NAME=${{GLOBAL_RELEASE_VERSION}}.${{CF_BRANCH_TAG_NORMALIZED}}-SNAPSHOT

  ReleaseNameForTag:
    image: alpine/git
    when:
      condition:
        all:
          releaseNameNotDefined: "${{IS_RELEASE}} == true"
    commands:
      - cf_export RELEASE_NAME=${{CF_RELEASE_TAG}}

  MvnSettings:
    image: alpine/git
    commands:
      - cf_export MVN_CLI_OPT="-Dmaven.repo.local=\"${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}_m2/repository\""
      - echo $MVN_CLI_OPT
      - cf_export GPG_IMPORT_COMMAND="cat <(echo -e '${{GPG_PRIVATE_KEY}}') | gpg --batch --import" --mask

  Build:
    no_cache: true
    no_cf_cache: true
    image: maven:3.9.11-eclipse-temurin-21-alpine
    working_directory: ./
    commands:
      - mvn ${{MVN_SET_VERSION}}
      - bash -c "${{GPG_IMPORT_COMMAND}}"
      - export CI_DEPLOY_USERNAME="${{CI_DEPLOY_USERNAME}}"
      - export CI_DEPLOY_PASSWORD="${{CI_DEPLOY_PASSWORD}}"
      - export GPG_KEYNAME="${{GPG_KEYNAME}}"
      - export GPG_PASSPHRASE="${{GPG_PASSPHRASE}}"
      - mvn -s settings.xml -U -B ${{MVN_CLI_OPT}} clean install org.sonatype.central:central-publishing-maven-plugin:0.7.0:publish -P release

  PauseForMavenPublish:
    type: freestyle
    image: ellerbrock/alpine-bash-curl-ssl
    shell: bash
    when:
      condition:
        all:
          buildPassed: steps.Build.result == 'success'
          isRelease: "${{IS_RELEASE}}"
    commands:
      - FMPL=$(curl -L -o /dev/null -s -w "%{http_code}\n"  https://repo1.maven.org/maven2/com/regnosys/rune-fpml/rosetta-source/${{RELEASE_NAME}}/rosetta-source-${{RELEASE_NAME}}.pom)
      - if [[ $FMPL == 200 ]]; then exit 0; else exit 1; fi
    retry:
      maxAttempts: 20
      delay: 180
      exponentialFactor: 1
